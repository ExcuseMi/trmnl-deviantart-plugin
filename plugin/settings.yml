---
strategy: polling
no_screen_padding: 'no'
dark_mode: 'no'
static_data: ''
polling_verb: get
polling_url: "{% liquid \r\n  # Get settings with defaults\r\n  assign mature_content = trmnl.plugin_settings.custom_fields_values.mature_content | default: \"true\"\r\n  assign raw_tags_string = trmnl.plugin_settings.custom_fields_values.tags | default: \"\"\r\n  assign raw_endpoints = trmnl.plugin_settings.custom_fields_values.endpoints | default: \"\"\r\n\r\n  # Clean up and validate endpoints\r\n  assign cleaned_endpoints = raw_endpoints | replace: '[', '' | replace: ']', '' | replace: '\"', '' | strip\r\n  \r\n  # Split into array\r\n  assign endpoints_array = cleaned_endpoints | split: \",\"\r\n  \r\n  # Filter out empty endpoints\r\n  assign valid_endpoints = \"\"\r\n  for endpoint in endpoints_array\r\n    assign trimmed = endpoint | strip\r\n    if trimmed != \"\" and trimmed != blank\r\n      if valid_endpoints == \"\"\r\n        assign valid_endpoints = trimmed\r\n      else\r\n        assign valid_endpoints = valid_endpoints | append: \",\" | append: trimmed\r\n      endif\r\n    endif\r\n  endfor\r\n  \r\n  # Convert back to array\r\n  assign valid_endpoints_array = valid_endpoints | split: \",\"\r\n  \r\n  # If no valid endpoints, use default\r\n  if valid_endpoints_array.size == 0 or valid_endpoints_array[0] == \"\"\r\n    assign valid_endpoints_array = \"browse/dailydeviations?limit=25\" | split: \",\"\r\n  endif\r\n\r\n  # Process tags\r\n  assign raw_tags_array = raw_tags_string | split: \",\"\r\n  assign valid_tags = \"\"\r\n  \r\n  for tag in raw_tags_array\r\n    assign trimmed_tag = tag | strip\r\n    if trimmed_tag != \"\" and trimmed_tag != blank\r\n      if valid_tags == \"\"\r\n        assign valid_tags = trimmed_tag\r\n      else\r\n        assign valid_tags = valid_tags | append: \",\" | append: trimmed_tag\r\n      endif\r\n    endif\r\n  endfor\r\n  \r\n  assign valid_tags_array = valid_tags | split: \",\"\r\n\r\n  # Generate all possible URLs\r\n  assign all_urls_string = \"\"\r\n  \r\n  for endpoint in valid_endpoints_array\r\n    assign current_endpoint = endpoint | strip\r\n    \r\n    if current_endpoint contains \"browse/tags\"\r\n      # For tag endpoints, generate one URL per tag\r\n      if valid_tags_array.size > 0 and valid_tags_array[0] != \"\"\r\n        for tag in valid_tags_array\r\n          assign encoded_tag = tag | url_encode\r\n          assign tag_endpoint = \"browse/tags?limit=25&tag=\" | append: encoded_tag\r\n          \r\n          # Build full URL\r\n          assign base_url = \"https://www.deviantart.com/api/v1/oauth2/\"\r\n          assign polling_url = base_url | append: tag_endpoint\r\n          \r\n          # Add mature_content parameter\r\n          if tag_endpoint contains \"?\"\r\n            assign polling_url = polling_url | append: \"&mature_content=\" | append: mature_content\r\n          else\r\n            assign polling_url = polling_url | append: \"?mature_content=\" | append: mature_content\r\n          endif\r\n          \r\n          # Add to string\r\n          if all_urls_string == \"\"\r\n            assign all_urls_string = polling_url\r\n          else\r\n            assign all_urls_string = all_urls_string | append: \"|||\" | append: polling_url\r\n          endif\r\n        endfor\r\n      else\r\n        # No tags available, fall back to daily deviations\r\n        assign fallback_endpoint = \"browse/dailydeviations?limit=25\"\r\n        assign base_url = \"https://www.deviantart.com/api/v1/oauth2/\"\r\n        assign polling_url = base_url | append: fallback_endpoint\r\n        assign polling_url = polling_url | append: \"?mature_content=\" | append: mature_content\r\n        \r\n        if all_urls_string == \"\"\r\n          assign all_urls_string = polling_url\r\n        else\r\n          assign all_urls_string = all_urls_string | append: \"|||\" | append: polling_url\r\n        endif\r\n      endif\r\n    else\r\n      # Regular endpoint\r\n      assign base_url = \"https://www.deviantart.com/api/v1/oauth2/\"\r\n      assign polling_url = base_url | append: current_endpoint\r\n      \r\n      # Add mature_content parameter\r\n      if current_endpoint contains \"?\"\r\n        assign polling_url = polling_url | append: \"&mature_content=\" | append: mature_content\r\n      else\r\n        assign polling_url = polling_url | append: \"?mature_content=\" | append: mature_content\r\n      endif\r\n      \r\n      # Add to string\r\n      if all_urls_string == \"\"\r\n        assign all_urls_string = polling_url\r\n      else\r\n        assign all_urls_string = all_urls_string | append: \"|||\" | append: polling_url\r\n      endif\r\n    endif\r\n  endfor\r\n\r\n  # Convert to array\r\n  assign all_urls = all_urls_string | split: \"|||\"\r\n  \r\n  # Select 3 random URLs from all_urls\r\n  assign selected_urls_string = \"\"\r\n  assign total_urls = all_urls.size\r\n  assign base_seed = \"now\" | date: \"%s\"\r\n  \r\n  if total_urls <= 3\r\n    # If 3 or fewer URLs, take all of them\r\n    assign selected_urls_string = all_urls_string\r\n  else\r\n    # Create a list of indices and shuffle approach\r\n    assign indices = \"\"\r\n    for i in (0..total_urls-1)\r\n      if indices == \"\"\r\n        assign indices = i\r\n      else\r\n        assign indices = indices | append: \",\" | append: i\r\n      endif\r\n    endfor\r\n    \r\n    assign indices_array = indices | split: \",\"\r\n    \r\n    # Simple approach: just pick random indices, allowing duplicates\r\n    # Since it's random per request, duplicates are unlikely and acceptable\r\n    for i in (1..3)\r\n      assign random_index = base_seed | plus: i | times: 997 | modulo: total_urls\r\n      assign selected_url = all_urls[random_index]\r\n      \r\n      if selected_urls_string == \"\"\r\n        assign selected_urls_string = selected_url\r\n      else\r\n        assign selected_urls_string = selected_urls_string | append: \"|||\" | append: selected_url\r\n      endif\r\n    endfor\r\n  endif\r\n  \r\n  assign selected_urls = selected_urls_string | split: \"|||\"\r\n%}\r\n\r\n{% for url in selected_urls %}\r\n{{ url }}\r\n{% endfor %}"
polling_headers: Authorization=Bearer {{ oauth_access_token }}&Content-Type=application/json
polling_body: ''
id: 246026
custom_fields:
- keyname: author_bio
  field_type: author_bio
  name: About This Plugin
  description: |
    Display personalised art from <a href="https://www.deviantart.com/">DeviantArt</a> on your TRMNL device.<br /><br />

    <strong>Requires OAuth</strong>
  category: art,images
  github_url: https://github.com/ExcuseMi/trmnl-deviantart-plugin
  learn_more_url: https://www.deviantart.com/
- keyname: endpoints
  field_type: select
  name: Feed
  help_text: Use <kbd>âŒ˜</kbd>+<kbd>click</kbd> or <kbd>ctrl</kbd>+<kbd>click</kbd> to select and deselect multiple options.
  options:
  - Daily Deviations: browse/dailydeviations?limit=25
  - Deviants You Watch: browse/deviantsyouwatch?limit=25
  - Home Feed: browse/home?limit=25
  - Tags: browse/tags/limit=25&tag=
  multiple: true
- keyname: tags
  field_type: multi_string
  name: Tags
  description: Choose one or more tags to display.<br />DeviantArt has user defined tags, so there's not set list of tags.
  help_text: The given tags will only be shown when the Feed field includes Tags.
  placeholder: digitalart
- keyname: mature_content
  field_type: boolean
  name: Mature Content
  description: If the feed supports mature content, this will allow it.
  optional: true
name: DeviantArt
refresh_interval: 15
